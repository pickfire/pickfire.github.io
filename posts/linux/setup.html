<!doctype html><html lang="en"><title>New system setup: Coreboot + Grub + Luks + Btrfs + Alpine</title><meta charset="utf-8"><meta name="description" content="Pickfire's happy website by itself"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/pub/style.css"><link href=/posts/linux/atom.xml type=application/atom+xml rel=alternate title="Pickfire linux ATOM Feed"><header><a id="fire" href="/">Site </a><span><strong>Posts</strong><span id=info> - <em>Embrace the Unknown</em></span></span></header><menu><span class="left"><a href=/about/>About</a><a href=/links/>Links</a><a href=/posts/ id='here'>Posts</a></span><span class="right"><a id="tor" href="http://pickfireywcq2wf2.onion/">Tor</a></span></menu><nav><ul><li><a href="/posts/craft/">Craft/</a></li><li><a href="/posts/learn/">Learn/</a></li><li><a href="/posts/linux/" class=site>Linux/</a><ul><li><a href="/posts/linux/backup.html">Backup</a></li><li><a href="/posts/linux/block.html">Block</a></li><li><a href="/posts/linux/dev.html">Dev</a></li><li><a href="/posts/linux/fast.html">Fast</a></li><li><a href="/posts/linux/multi-pointer.html">Multi-pointer</a></li><li><a href="/posts/linux/parallel.html">Parallel</a></li><li><a href="/posts/linux/phone.html">Phone</a></li><li><a href="/posts/linux/setup.html" class=site>Setup</a></li></ul></li></ul></nav><main><h1>New system setup: Coreboot + Grub + Luks + Btrfs + Alpine</h1><p>I used Arch Linux for some time, should switch to Alpine Linux for simplicity.
The setup will be on thinkpad x220 brought from <a href="//hendry.iki.fi/">Kai Hendry</a>, thanks to
him for keeping his laptop in good state. :)</p><p>Quick overview:</p><ul><li>Bootloader: Coreboot + Grub payload (testing)</li><li>Encryption: Dm-crypt LUKS + key file from sd card</li><li>Filesystem: Btrfs raid 0 (data) + raid 1 (metadata)</li><li>Root setup: Alpine Linux</li></ul><h2>Setting up Coreboot</h2><p>Why switch to coreboot? Default firmware took 8s to boot. Now <code>x &lt; 2s</code>. Haha!</p><ol><li><p>Preparation</p><ol><li>Get raspberry pi 2 and <a href="//www.ebay.com/itm/162284060668?_trksid=p2057872.m2749.l2649&amp;ssPageName=STRK%3AMEBIDX%3AIT">SOIC clip + probe cables</a></li><li>Install flashrom and build coreboot with grub2 payload</li><li>Prerequisite: <code>make crossgcc-i386 CPUS=4</code>, <code>make iasl</code></li></ol></li><li><p>Set up flasher - <a href="//www.coreboot.org/Board:lenovo/x220">coreboot wiki</a> and <a href="//tylercipriani.com/blog/2016/11/13/coreboot-on-the-thinkpad-x220-with-a-raspberry-pi/">tylercipriani</a></p><ol><li><a href="//support.lenovo.com/us/en/videos/pd022683">Lenovo guide to remove keyboard and palm rest</a></li><li>Purge any power source of laptop &amp; programmer (rpi2)</li><li>Connect the probe cables between programmer and chip</li><li>Then <strong>only turn on the power source</strong> of programmer</li></ol></li><li><p>(Optional) Extracting the VGA BIOS which is better than SeaVGABios</p><ol><li>More info available at <a href="//nroach44.id.au/index.php/2016/12/11/thinkpad-x220-coreboot-and-me-removal/">nroach44</a> and <a href="//www.coreboot.org/VGA_support#UEFI_Method">coreboot wiki</a></li><li>Download, build <a href="//github.com/LongSoft/UEFITool">uefitool</a>, open factory.rom with uefitool</li><li>Search for text &quot;VGA Compatible BIOS&quot; with unicode <strong>unchecked</strong></li><li>Double click matching result, then extract body of <code>Raw section</code></li><li>(Optional) check word &quot;VGA Display controller&quot; with <code>romheaders</code></li></ol></li><li><p>(Optional) Cleaning up me.bin (now this option is in nconfig)</p><ol><li>More info available at <a href="//nroach44.id.au/index.php/2017/01/24/thinkpad-x220-shrink-the-me-region/">nroach44</a></li><li>Necessary: <code>util/me_cleaner/me_cleaner.py build/coreboot.bin</code></li><li>(Optional) Verify that <code>util/intelmetool/intelmetool -s</code> show
output &quot;Firmware Init Complete&quot; as &quot;NO&quot;</li><li>To proceed - <code>util/me_cleaner/me_cleaner.py me.bin</code> and <code>make</code></li><li><code>hexdump me.bin</code> and check last byte which have tons of <code>ffff</code></li><li><code>dd if=me.bin of=truc.bin bs=1 count=$(printf '%d' 0x00dbc90)</code></li></ol></li><li><p>(Optional) Setting battery threshold</p><ol><li>More info available at <a href="//wej.k.vu/coreboot/coreboot_on_the_lenovo_thinkpad_x220">vej's blog</a></li><li>Build util/ectool</li><li>Battery start threshold 75% - <code>util/ectool -w 0xb1 -z 0x4b</code></li><li>Battery stop threshold 80%  - <code>util/ectool -w 0xb1 -z 0x50</code></li></ol></li><li><p>Building coreboot</p><ol><li><p>More info available at <a href="//www.coreboot.org/Board:lenovo/x220">coreboot wiki x220 page</a></p></li><li><p>First check <code>flashrom -p linux_spi:dev=/dev/spidev0.0</code></p></li><li><p>If it gets an error: poweroff, reconnect pin and boot</p></li><li><p><code>flashrom -p linux_spi:dev=/dev/spidev0.0 -r orig.bin</code></p></li><li><p>Check orig.bin hash &amp; redo step 4-5, not same? step 2</p></li><li><p>Extract the factory binary blob: <code>ifdtool -x orig.bin</code></p></li><li><p>Move outputs to <code>3rdparty/blobs/mainboard/lenovo/x220</code></p></li><li><p>Rename files as &quot;descriptor.bin&quot;, &quot;gbe.bin&quot;, &quot;me.bin&quot;</p></li><li><p><code>make nconfig</code> and tune it accordingly .config (dead)</p></li><li><p>If it builds, verify with step 4-5 twice and finally:</p><pre><code>flashrom -p linux_spi:dev=/dev/spidev0.0 -w build/coreboot.rom
</code></pre></li></ol></li><li><p>After coreboot is flashed, internal flashing can be done by:</p><ul><li><code>iomem=relaxed</code> in cmdline</li><li><code>flashrom -p internal:laptop=force_I_want_a_brick -c MX25L6405 -w build/coreboot.rom --ifd -i bios -n</code></li></ul></li><li><p>Tips and tricks:</p><ul><li>Find bootorder with <code>CONFIG_USE_OPTION_TABLE</code>, <code>CONFIG_CONSOLE_CBMEM</code>,
<code>DEFAULT_CONSOLE_LOGLEVEL_6</code>, then <code>util/cbmem/cbmem -c | grep booto</code>.</li><li>The extra config such as <code>bootorder</code>, <code>config_seabios</code> can be set with
<code>$(top)/src/mainboard/$(MAINBOARDDIR)/*</code> where you can store it inside
<code>src/mainboard/lenovo/x220/</code> to differentiate between different boards.</li></ul></li></ol><p><img src="img/setup1.png" alt="img" /></p><h2>Setting up a testing environment</h2><p>This is just some random stuff how I tested it out with qemu, might help.</p><h2>Setting up full disk encryption</h2><p>For how it is now, I will just draw an image:</p><pre><code>+------------------------+     +------------------------+
| /dev/sda1 111GB (root) |----&gt;| /dev/mapper/p0 (crypt) |-------------+
+------------------------+     +------------------------+             v
| /dev/sda2   8GB (swap) |                                   +-----------------+
+------------------------+                                   | / - btrfs raid0 |
                                                             +-----------------+
+------------------------+     +------------------------+             ^
| /dev/sdb  119GB (root) |----&gt;| /dev/mapper/p1 (crypt) |-------------+ 
+------------------------+     +------------------------+              
</code></pre><ul><li><a href="https://wiki.archlinux.org/index.php/GRUB/Tips_and_tricks">https://wiki.archlinux.org/index.php/GRUB/Tips_and_tricks</a></li><li><a href="https://www.gnu.org/software/grub/manual/grub.html#Security">https://www.gnu.org/software/grub/manual/grub.html#Security</a></li><li><a href="https://www.reddit.com/r/coreboot/comments/4uahg5/coreboot_on_x220_examples_of_grubcfg_with_support">https://www.reddit.com/r/coreboot/comments/4uahg5/coreboot_on_x220_examples_of_grubcfg_with_support</a></li><li><a href="https://notabug.org/vimuser/libreboot/src/master/resources/grub/config">https://notabug.org/vimuser/libreboot/src/master/resources/grub/config</a></li><li><a href="https://www.coreboot.org/GRUB2#Security">https://www.coreboot.org/GRUB2#Security</a></li></ul></main><footer><span class="right"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC-BY</a>&ensp;<a href="/about/contact.html">Ivan Tham</a><link rel="stylesheet" href="/tor.css">
